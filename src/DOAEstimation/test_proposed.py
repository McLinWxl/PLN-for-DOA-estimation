#  Copyright (c) 2024. Lorem ipsum dolor sit amet, consectetur adipiscing elit.
#  Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.
#  Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.
#  Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.
#  Vestibulum commodo. Ut rhoncus gravida arcu.

#  Copyright (c) 2024. Lorem ipsum dolor sit amet, consectetur adipiscing elit.
#  Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.
#  Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.
#  Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.
#  Vestibulum commodo. Ut rhoncus gravida arcu.

import torch

from ISTA import ISTA
from __init__ import args_doa, args_unfolding_doa
from proposedMethods import proposedMethods

args = args_doa()
args_unfolding = args_unfolding_doa()
import matplotlib.pyplot as plt
import numpy as np
from functions import Spect2DoA_no_insert, calculate_error, DatasetGeneration_sample

# from functions import Spect2DoA_no_insert, calculate_error, DatasetGeneration_sample

if __name__ == '__main__':
    dataset_ld = torch.load('../../data/data2test_g0.pt')
    print(f"Dataset length: {len(dataset_ld)}")
    test_loader = torch.utils.data.DataLoader(dataset_ld, batch_size=len(dataset_ld), shuffle=True)
    # test_loader = torch.utils.data.DataLoader(dataset_ld, batch_size=1, shuffle=False)

    method = 'ISTA'
    num_iters = args_unfolding.num_layers
    print(f"Method: {method}, Num Iters: {num_iters}")
    num_sources = 1
    match method:
        case 'Pro':
            model = proposedMethods()
            match num_iters:
                case 10:
                    theta = [-0.0881404, 0.00372594, 0.14535268, 0.31400169, 0.41754649, 0.37060898, 0.31468127,
                             0.30356269, 0.2974163, 0.27746496]
                    gamma = [-0.34941014, -0.37966787, -0.39289938, -0.40380213, -0.3850354,
                             -0.36307729, -0.34874784, -0.34742324, -0.34972151, -0.34296854]
                case 20:
                    theta = [-0.21346137, -0.20224275, -0.20408241, -0.18827439, -0.17776106,
                             -0.15486533, -0.11179819, -0.04427006, 0.03622481, 0.14650429,
                             0.27042487, 0.42670802, 0.42595356, 0.3926598, 0.35097485,
                             0.31698533, 0.30649215, 0.2963326, 0.29482808, 0.28650265]
                    gamma = [-0.22561044, -0.23557413, -0.25541074, -0.27967169, -0.31250842,
                             -0.35681894, -0.40097969, -0.4131953, -0.43268753, -0.44320752,
                             -0.44029216, -0.42833793, -0.41124566, -0.39361013, -0.38238958,
                             -0.35259086, -0.34786178, -0.35165988, -0.34719868, -0.34402705]
                case 40:
                    theta = [-0.20417519, -0.20093906, -0.21502354, -0.2086815, -0.21645241,
                             -0.20999752, -0.21288429, -0.20653003, -0.20742247, -0.21379398,
                             -0.21000535, -0.21424444, -0.21017329, -0.20139206, -0.2005368,
                             -0.18046668, -0.18749287, -0.16489637, -0.15350528, -0.13025796,
                             -0.10306808, -0.05941025, -0.01278654, 0.05263947, 0.1335534,
                             0.21266648, 0.30074228, 0.36650347, 0.39093986, 0.3896431,
                             0.3685851, 0.34995632, 0.32852467, 0.31424956, 0.30738388,
                             0.3007817, 0.29849694, 0.3017372, 0.28870689, 0.28365327]
                    gamma = [-0.20400939, -0.20081955, -0.21002216, -0.21588753, -0.20672235,
                             -0.20604058, -0.20570081, -0.20784618, -0.21142901, -0.21636743,
                             -0.21768477, -0.22286789, -0.23995821, -0.24975267, -0.2794993,
                             -0.29903629, -0.32624406, -0.35927933, -0.397671, -0.42550977,
                             -0.43992246, -0.44963454, -0.46614218, -0.45484325, -0.45218328,
                             -0.45982635, -0.44236295, -0.4355274, -0.42571619, -0.41372993,
                             -0.40672815, -0.3853973, -0.37034168, -0.34774183, -0.34834934,
                             -0.35018567, -0.35209368, -0.34621139, -0.34905275, -0.34373528]
                case 80:
                    theta = [-0.17474364, -0.17304138, -0.17890514, -0.17036586, -0.17832985,
                             -0.17840576, -0.17303934, -0.17843414, -0.18376019, -0.18085293,
                             -0.17517853, -0.17805082, -0.18037457, -0.17639571, -0.17840185,
                             -0.18406911, -0.17875878, -0.18053085, -0.17909906, -0.17222914,
                             -0.18344779, -0.1722623, -0.17936754, -0.1755463, -0.17833976,
                             -0.18555462, -0.17968389, -0.17128316, -0.18314108, -0.18315155,
                             -0.17571197, -0.17260446, -0.18025322, -0.17008268, -0.17501731,
                             -0.17657195, -0.1758872, -0.17662285, -0.18197072, -0.17643065,
                             -0.17166876, -0.16956664, -0.17417077, -0.17116035, -0.1643082,
                             -0.1686235, -0.17416587, -0.15973308, -0.14903776, -0.15076157,
                             -0.13482454, -0.13381169, -0.11620011, -0.10031473, -0.0831769,
                             -0.05762666, -0.03013861, -0.00604163, 0.02007918, 0.06055918,
                             0.09704162, 0.13314645, 0.18519285, 0.24955455, 0.33795841,
                             0.4247097, 0.44096804, 0.42189026, 0.39586972, 0.37217275,
                             0.34668109, 0.33081866, 0.32064807, 0.31617567, 0.2942139,
                             0.29237647, 0.29084208, 0.285154, 0.28028336, 0.2789198]
                    gamma = [-0.18053345, -0.17243316, -0.17663853, -0.16958929, -0.17017754,
                             -0.18197065, -0.16959207, -0.1690475, -0.177824, -0.1763189,
                             -0.17905227, -0.17662498, -0.17270402, -0.16323605, -0.17049725,
                             -0.16758798, -0.17243101, -0.16740706, -0.1691505, -0.16824611,
                             -0.16002157, -0.16429888, -0.16434333, -0.16354133, -0.17479465,
                             -0.17808053, -0.1735309, -0.18057317, -0.17829627, -0.18448684,
                             -0.17414507, -0.17872746, -0.17935621, -0.17853242, -0.17962647,
                             -0.17799058, -0.17480377, -0.18595738, -0.18989318, -0.1924971,
                             -0.20599245, -0.20556037, -0.22749936, -0.2447727, -0.26772983,
                             -0.27932498, -0.30611612, -0.3199457, -0.33744165, -0.36386117,
                             -0.38406786, -0.39655213, -0.41382327, -0.42474411, -0.4457523,
                             -0.45355386, -0.4518928, -0.45739413, -0.46130525, -0.46128138,
                             -0.45521018, -0.45981932, -0.44694097, -0.44454323, -0.4360007,
                             -0.43193633, -0.42130352, -0.41462646, -0.40124626, -0.38246235,
                             -0.36707168, -0.36211733, -0.35438625, -0.34539411, -0.35204072,
                             -0.35405937, -0.35465178, -0.35616539, -0.35344169, -0.3427969]
                case 160:
                    theta = [-0.16834702, -0.17830434, -0.17480325, -0.17709941, -0.17599871,
                             -0.17897905, -0.17134539, -0.17591191, -0.17146376, -0.1830377,
                             -0.17278078, -0.17632774, -0.18508082, -0.17733484, -0.16952828,
                             -0.17668096, -0.17889428, -0.17628421, -0.18323939, -0.17487162,
                             -0.17218474, -0.16767286, -0.17290834, -0.17464711, -0.17441143,
                             -0.17520348, -0.17652761, -0.17816628, -0.18033029, -0.17627638,
                             -0.16795939, -0.17371348, -0.17781111, -0.17630773, -0.17841609,
                             -0.17818493, -0.18297884, -0.17987451, -0.18181138, -0.18404825,
                             -0.18022466, -0.17322402, -0.1750057, -0.17722708, -0.17605067,
                             -0.18252167, -0.17621537, -0.18072354, -0.17959915, -0.18296418,
                             -0.17888092, -0.18323953, -0.16990818, -0.17781598, -0.1715141,
                             -0.17323997, -0.1822642, -0.17423045, -0.17829181, -0.17145596,
                             -0.17588454, -0.17253691, -0.17969714, -0.16982286, -0.16903538,
                             -0.17519757, -0.17690323, -0.17468041, -0.17804378, -0.17433535,
                             -0.16875906, -0.1766592, -0.16836491, -0.1737226, -0.17383986,
                             -0.16620741, -0.17586316, -0.17229157, -0.17028256, -0.16871889,
                             -0.18160871, -0.16844575, -0.17311419, -0.17591374, -0.17500136,
                             -0.16772881, -0.17461005, -0.16811775, -0.1723463, -0.17725347,
                             -0.17375029, -0.16855195, -0.16649913, -0.17333683, -0.17185355,
                             -0.17447741, -0.1699052, -0.17103038, -0.1731896, -0.16949457,
                             -0.17735207, -0.17909417, -0.17151187, -0.1709972, -0.17134577,
                             -0.16966993, -0.17381781, -0.16615273, -0.17258518, -0.16640677,
                             -0.1724038, -0.16067301, -0.16093337, -0.15197777, -0.14617831,
                             -0.13620311, -0.12905707, -0.1239239, -0.10942182, -0.09232574,
                             -0.07348106, -0.0497169, -0.02312023, 0.01227379, 0.04936634,
                             0.0842073, 0.12816546, 0.15862463, 0.20348797, 0.22819656,
                             0.27986761, 0.30613331, 0.3356053, 0.35179334, 0.36580227,
                             0.37016071, 0.37606024, 0.38006801, 0.3701403, 0.36367472,
                             0.3589444, 0.35257924, 0.34679839, 0.33592764, 0.33079039,
                             0.32237909, 0.31497412, 0.30674471, 0.30832237, 0.30472333,
                             0.2977225, 0.30740055, 0.29317955, 0.30521926, 0.28617198,
                             0.28526699, 0.28571692, 0.29668347, 0.29637064, 0.29162194]
                    gamma = [-0.16740704, -0.17330936, -0.17315033, -0.17705373, -0.1812878,
                             -0.17041597, -0.17488275, -0.17668278, -0.17827745, -0.17100667,
                             -0.17627777, -0.17776098, -0.1775216, -0.16738234, -0.17316621,
                             -0.17378294, -0.17486724, -0.17988316, -0.16899265, -0.17051975,
                             -0.17973385, -0.18484087, -0.188395, -0.1848525, -0.18672968,
                             -0.1847631, -0.18306871, -0.18642119, -0.17794477, -0.17832719,
                             -0.16235352, -0.1583137, -0.15525162, -0.1490945, -0.15087381,
                             -0.13149627, -0.11941018, -0.12080628, -0.10543536, -0.11268389,
                             -0.12887441, -0.12109544, -0.11682484, -0.12141219, -0.11941314,
                             -0.13145363, -0.12082375, -0.12034881, -0.12711939, -0.12142155,
                             -0.12758896, -0.13113481, -0.13369513, -0.12908868, -0.12548774,
                             -0.13125731, -0.12917743, -0.1317874, -0.12880407, -0.12726955,
                             -0.12540962, -0.12093586, -0.12048488, -0.1205003, -0.11633421,
                             -0.11771177, -0.10938417, -0.11379634, -0.10377631, -0.10302672,
                             -0.08543879, -0.09431935, -0.08768255, -0.08358036, -0.08718834,
                             -0.07999849, -0.07341404, -0.07378598, -0.07824682, -0.06483747,
                             -0.06045769, -0.07138042, -0.06183612, -0.0595015, -0.05591242,
                             -0.0497858, -0.05252542, -0.04804349, -0.04092808, -0.03194757,
                             -0.02904194, -0.02918675, -0.02276451, -0.02926436, -0.01390588,
                             -0.02111396, -0.01511493, -0.01146935, -0.00525851, -0.00586763,
                             0.0022805, -0.00930025, -0.00097374, -0.00258537, -0.01362942,
                             -0.0117576, -0.02103748, -0.02707498, -0.04477863, -0.06508248,
                             -0.08267326, -0.10895845, -0.14354393, -0.18038055, -0.20933966,
                             -0.24482464, -0.28514299, -0.30756591, -0.33726556, -0.3566507,
                             -0.37903369, -0.39616424, -0.40556532, -0.40560505, -0.40577472,
                             -0.41582041, -0.42865046, -0.42983605, -0.43457136, -0.43243791,
                             -0.43445179, -0.42588485, -0.43697271, -0.4281705, -0.41379753,
                             -0.42126487, -0.41786268, -0.41961977, -0.41185099, -0.40709261,
                             -0.40596485, -0.39023159, -0.38717459, -0.3660823, -0.36857426,
                             -0.36758155, -0.35431777, -0.3576637, -0.34985549, -0.35088295,
                             -0.34838361, -0.35149584, -0.3463951, -0.34642118, -0.34853866,
                             -0.34458528, -0.34419987, -0.34606583, -0.34698181, -0.35122676]
                case 320:
                    theta = [-0.23375944, -0.22391358, -0.22965866, -0.24354127, -0.22545734,
                             -0.22275088, -0.2371711, -0.23148447, -0.2286394, -0.22949583,
                             -0.2254094, -0.23288502, -0.23440456, -0.22975829, -0.22923312,
                             -0.23090445, -0.23210564, -0.22688224, -0.23098882, -0.23364339,
                             -0.23433992, -0.23084986, -0.22774045, -0.23498956, -0.22242581,
                             -0.22933938, -0.22930836, -0.22775892, -0.23494966, -0.22693274,
                             -0.23023289, -0.22461929, -0.22735227, -0.22297318, -0.22662648,
                             -0.2312364, -0.23415934, -0.23120708, -0.22943232, -0.22623306,
                             -0.22493866, -0.22946753, -0.2329839, -0.23520374, -0.23191639,
                             -0.22709694, -0.23190705, -0.23453938, -0.22289771, -0.22944681,
                             -0.23066777, -0.22938346, -0.23112476, -0.23076117, -0.23343268,
                             -0.23904145, -0.23487003, -0.23204061, -0.23563412, -0.23241764,
                             -0.23257608, -0.23262743, -0.23549382, -0.23200029, -0.23306372,
                             -0.22863284, -0.22930254, -0.22649847, -0.23994506, -0.22980947,
                             -0.2378401, -0.23970763, -0.22757128, -0.23205535, -0.22794527,
                             -0.23553332, -0.23439741, -0.23463632, -0.23099701, -0.22776815,
                             -0.22577772, -0.21883818, -0.22870781, -0.23793651, -0.2292318,
                             -0.24034131, -0.23972072, -0.23283576, -0.23669474, -0.22792893,
                             -0.22690822, -0.23416484, -0.22801928, -0.22955013, -0.22187954,
                             -0.21772609, -0.22799042, -0.23377028, -0.23351531, -0.23219309,
                             -0.22924202, -0.22266502, -0.22852608, -0.22986691, -0.22945846,
                             -0.22458298, -0.21744826, -0.22745194, -0.2322256, -0.2227432,
                             -0.22685634, -0.22415929, -0.23311955, -0.23818025, -0.22451639,
                             -0.21141988, -0.23422206, -0.21824285, -0.22064822, -0.23138187,
                             -0.22386324, -0.22649344, -0.22442513, -0.22683788, -0.22534898,
                             -0.23005297, -0.22266294, -0.22856979, -0.2206577, -0.22933851,
                             -0.22336599, -0.22193779, -0.22972676, -0.2223047, -0.22717638,
                             -0.22578571, -0.22276276, -0.2301607, -0.22135986, -0.22536961,
                             -0.22815333, -0.22702385, -0.22938582, -0.23007481, -0.23681662,
                             -0.22984123, -0.22773721, -0.22489821, -0.23333934, -0.22303978,
                             -0.22536833, -0.22550904, -0.23257345, -0.22488502, -0.22635423,
                             -0.22188109, -0.21832319, -0.22883406, -0.22993714, -0.23124143,
                             -0.22842415, -0.22667419, -0.22190156, -0.22320426, -0.23193916,
                             -0.22981566, -0.23051731, -0.22569047, -0.23291776, -0.22856666,
                             -0.23551517, -0.23355092, -0.23121929, -0.2341044, -0.22932312,
                             -0.2256959, -0.23298853, -0.22948507, -0.23397719, -0.23532296,
                             -0.22885798, -0.23450633, -0.23495535, -0.23742698, -0.23344797,
                             -0.23676068, -0.2385143, -0.23814101, -0.22738544, -0.23808904,
                             -0.23680909, -0.2264124, -0.23350519, -0.23463556, -0.22997391,
                             -0.22670223, -0.22791932, -0.23633538, -0.23688476, -0.2414582,
                             -0.23910726, -0.22977116, -0.23195165, -0.24403608, -0.23014074,
                             -0.23737078, -0.22953144, -0.24531811, -0.2394115, -0.22913241,
                             -0.2440915, -0.23572013, -0.2369251, -0.24398925, -0.24079569,
                             -0.23834005, -0.24533909, -0.23596537, -0.24025776, -0.23412062,
                             -0.23411696, -0.24055111, -0.23823355, -0.2387242, -0.23035179,
                             -0.23784869, -0.23213845, -0.22979254, -0.24124766, -0.24316558,
                             -0.245344, -0.2347729, -0.23193106, -0.23516093, -0.2400885,
                             -0.23822463, -0.2271176, -0.23103485, -0.2390146, -0.2464976,
                             -0.23370407, -0.2450779, -0.23687356, -0.23755459, -0.24148645,
                             -0.23760196, -0.24333506, -0.22725784, -0.23691672, -0.23353779,
                             -0.23087974, -0.23640368, -0.2247491, -0.22871628, -0.23778332,
                             -0.22802003, -0.2310117, -0.22292987, -0.22634473, -0.21770264,
                             -0.21639564, -0.21651803, -0.1945452, -0.19536556, -0.18867429,
                             -0.19020157, -0.17159035, -0.16509451, -0.16045555, -0.14525905,
                             -0.12956436, -0.11727781, -0.09931937, -0.09400278, -0.07662413,
                             -0.05517146, -0.04365572, -0.02723957, -0.00434339, 0.02650045,
                             0.05430524, 0.09510594, 0.14043895, 0.19907033, 0.25949354,
                             0.32426717, 0.37779582, 0.42189286, 0.4305571, 0.42870138,
                             0.42686203, 0.41383536, 0.40739877, 0.39426507, 0.39257128,
                             0.38227726, 0.38069563, 0.36599194, 0.35497637, 0.35074444,
                             0.33746433, 0.33307388, 0.32407157, 0.30735927, 0.31007681,
                             0.2910127, 0.28318167, 0.28059166, 0.26776227, 0.28557762,
                             0.28404225, 0.2920879, 0.28207687, 0.27902683, 0.28598834,
                             0.28612096, 0.29346832, 0.30157026, 0.29415848, 0.30252116]
                    gamma = [-2.28294447e-01, -2.29572281e-01, -2.38991138e-01, -2.34804487e-01,
                             -2.32569930e-01, -2.28322044e-01, -2.23942310e-01, -2.28296512e-01,
                             -2.27681112e-01, -2.27257985e-01, -2.24835184e-01, -2.26206359e-01,
                             -2.31883770e-01, -2.22494325e-01, -2.23110640e-01, -2.21332371e-01,
                             -2.19765067e-01, -2.25532368e-01, -2.11022785e-01, -2.22605506e-01,
                             -2.20189375e-01, -2.20511436e-01, -2.18118319e-01, -2.25853375e-01,
                             -2.27159458e-01, -2.29953030e-01, -2.38709441e-01, -2.36335152e-01,
                             -2.28534117e-01, -2.26106754e-01, -2.19324806e-01, -2.15438634e-01,
                             -2.16518366e-01, -2.18451908e-01, -2.11968458e-01, -2.07301423e-01,
                             -2.12756929e-01, -2.08095044e-01, -2.09423491e-01, -2.12970576e-01,
                             -2.12355217e-01, -2.16554976e-01, -2.06451166e-01, -2.12905428e-01,
                             -2.07028434e-01, -2.04539016e-01, -2.01428726e-01, -1.98792878e-01,
                             -2.03097862e-01, -1.93324894e-01, -1.99090227e-01, -1.91693699e-01,
                             -1.94828042e-01, -1.85396370e-01, -1.87714785e-01, -1.89381537e-01,
                             -1.80372381e-01, -1.90205973e-01, -1.91243562e-01, -1.90665770e-01,
                             -1.89093247e-01, -1.81928498e-01, -1.81517458e-01, -1.80114874e-01,
                             -1.89407095e-01, -1.79810718e-01, -1.87050664e-01, -1.79508960e-01,
                             -1.85300145e-01, -1.93295631e-01, -1.79381198e-01, -1.79194388e-01,
                             -1.96455532e-01, -1.87963507e-01, -1.85850418e-01, -1.93510801e-01,
                             -1.82831675e-01, -1.89611104e-01, -1.91793719e-01, -2.00485080e-01,
                             -1.85717672e-01, -1.95351130e-01, -1.89207792e-01, -1.90831271e-01,
                             -1.87918594e-01, -1.84770101e-01, -1.76972800e-01, -1.74273887e-01,
                             -1.81207111e-01, -1.70990723e-01, -1.65513739e-01, -1.75049499e-01,
                             -1.59569180e-01, -1.51273361e-01, -1.49279836e-01, -1.37297937e-01,
                             -1.33610079e-01, -1.30427311e-01, -1.24303454e-01, -1.15222475e-01,
                             -1.18546578e-01, -1.00471708e-01, -1.01549275e-01, -1.00471012e-01,
                             -9.21104297e-02, -9.04409856e-02, -8.25567544e-02, -7.51552008e-02,
                             -7.45634928e-02, -6.76651381e-02, -6.27421916e-02, -4.98229966e-02,
                             -5.66732220e-02, -4.19399042e-02, -4.20922406e-02, -3.48643966e-02,
                             -2.98315410e-02, -1.58542475e-02, -1.76814706e-02, -1.46392543e-02,
                             -9.96111399e-03, -1.03409367e-02, -2.40137264e-03, 4.34945909e-03,
                             4.89326627e-03, 1.16985510e-03, 1.65286696e-02, 4.61213827e-03,
                             9.85331433e-03, 1.42641136e-02, 2.68692166e-02, 1.90580869e-02,
                             2.41454832e-02, 2.03303875e-02, 1.89699948e-02, 2.94817094e-02,
                             3.52705453e-02, 3.93989995e-02, 3.73720374e-02, 3.82606305e-02,
                             3.76743589e-02, 3.81501921e-02, 3.72165810e-02, 4.77146801e-02,
                             4.98523034e-02, 4.99111354e-02, 3.90673369e-02, 4.18424860e-02,
                             5.07265694e-02, 3.44740029e-02, 4.43058982e-02, 4.34903927e-02,
                             3.97794109e-02, 3.84261854e-02, 4.15140815e-02, 3.07932388e-02,
                             4.09832060e-02, 3.80295530e-02, 2.58728225e-02, 3.57542023e-02,
                             3.14898556e-02, 3.57865807e-02, 2.56320467e-02, 3.25417336e-02,
                             2.59280931e-02, 2.28345701e-02, 2.77569704e-02, 2.87837557e-02,
                             2.21736427e-02, 2.62363533e-02, 1.23140508e-02, 1.85742173e-02,
                             2.28725291e-02, 1.90100145e-02, 2.07933048e-02, 7.89329316e-03,
                             2.07820095e-02, 2.02701213e-02, 1.19286717e-02, 2.91246455e-05,
                             5.61478771e-03, 9.10133717e-03, 6.21403344e-03, -8.56939470e-05,
                             6.94129216e-03, 1.23955704e-02, 1.74466590e-03, -4.73323492e-03,
                             -8.08358379e-04, -4.54349220e-03, -6.18007835e-03, -6.89119305e-03,
                             -6.52444782e-03, -8.62017851e-03, -1.23133551e-02, -3.26684272e-02,
                             -1.97961719e-02, -1.96197672e-02, -1.70528932e-02, -2.71563396e-02,
                             -1.83646893e-02, -2.45452285e-02, -2.56480427e-02, -2.86714781e-02,
                             -3.69301543e-02, -3.00169434e-02, -3.02406833e-02, -2.94502099e-02,
                             -3.38087268e-02, -3.48212623e-02, -3.52089748e-02, -4.31760166e-02,
                             -3.38909134e-02, -3.99719670e-02, -4.81233839e-02, -4.20080185e-02,
                             -5.21656789e-02, -4.90300028e-02, -4.75137025e-02, -4.41329304e-02,
                             -4.67963953e-02, -5.37695237e-02, -5.49057521e-02, -6.41459294e-02,
                             -5.69139853e-02, -6.55209363e-02, -5.53148933e-02, -5.97744875e-02,
                             -5.96134782e-02, -6.60722360e-02, -6.74468905e-02, -6.37189642e-02,
                             -7.08394207e-02, -7.75109872e-02, -7.89680451e-02, -7.10715100e-02,
                             -7.74648249e-02, -7.77351975e-02, -7.79981010e-02, -8.37227359e-02,
                             -8.40287514e-02, -9.03486371e-02, -9.39129606e-02, -9.48564932e-02,
                             -9.88999635e-02, -1.06389123e-01, -1.11682151e-01, -1.15580578e-01,
                             -1.28534853e-01, -1.21068764e-01, -1.23471199e-01, -1.43505114e-01,
                             -1.43529136e-01, -1.51774167e-01, -1.63445917e-01, -1.71654126e-01,
                             -1.87301573e-01, -2.01871392e-01, -2.11626083e-01, -2.33678618e-01,
                             -2.37156546e-01, -2.50824657e-01, -2.64598101e-01, -2.81109852e-01,
                             -2.94698298e-01, -3.13859338e-01, -3.12749535e-01, -3.29887599e-01,
                             -3.38944578e-01, -3.56173319e-01, -3.55530864e-01, -3.66180557e-01,
                             -3.82617861e-01, -3.92615992e-01, -3.87405342e-01, -3.99615580e-01,
                             -4.05711538e-01, -4.07767105e-01, -4.15891552e-01, -4.18439043e-01,
                             -4.22846770e-01, -4.18762952e-01, -4.22728527e-01, -4.22133631e-01,
                             -4.29882246e-01, -4.38941985e-01, -4.23936135e-01, -4.30712646e-01,
                             -4.25934923e-01, -4.23154891e-01, -4.21904874e-01, -4.21623832e-01,
                             -4.14048886e-01, -4.22584260e-01, -4.17571747e-01, -4.02328604e-01,
                             -4.04323971e-01, -3.99775010e-01, -3.93298340e-01, -3.89697921e-01,
                             -3.78193939e-01, -3.78081965e-01, -3.62856859e-01, -3.52635670e-01,
                             -3.51320416e-01, -3.37575889e-01, -3.35256356e-01, -3.38593799e-01,
                             -3.38809901e-01, -3.44755864e-01, -3.51318371e-01, -3.55171621e-01,
                             -3.38162488e-01, -3.31029803e-01, -3.43540204e-01, -3.49789417e-01,
                             -3.55738533e-01, -3.57611603e-01, -3.61150444e-01, -3.58017874e-01]
                case _:
                    raise ValueError(f"Invalid num_iters: {num_iters}")
            model.theta_amp = torch.nn.Parameter(torch.tensor(theta), requires_grad=False)
            model.gamma_amp = torch.nn.Parameter(torch.tensor(gamma), requires_grad=False)

        case 'ISTA':
            model = ISTA()

    plt.style.use(['science', 'ieee', 'grid'])
    for idx_epc, (data_samples, fre_center, fre_fault, spacing_sample, label_theta, label_SNR) in enumerate(
            test_loader):
        batch_size = data_samples.shape[0]
        args.antenna_distance = spacing_sample
        args.frequency_center = fre_center
        args.frequency_fault = fre_fault

        covariance_matrix_samples = torch.matmul(data_samples, data_samples.conj().transpose(2, 3)) / args.num_snapshots

        covariance_vector = covariance_matrix_samples.transpose(2, 3).reshape(covariance_matrix_samples.shape[0],
                                                                              covariance_matrix_samples.shape[1],
                                                                              args.antenna_num ** 2, 1)
        result_mulchannels, result, result_init_all = model(args, covariance_vector)

        result_ = result.reshape(-1, 121, 1)
        result_ = result_.cpu().detach().numpy()
        label_theta = label_theta.cpu().detach().numpy()
        label_theta = label_theta.reshape(-1, batch_size, num_sources)

        doa_est = Spect2DoA_no_insert(result_, num_sources=num_sources, start_bias=60)
        doa_est = doa_est.reshape(-1, batch_size, num_sources)
        error_, RMSE_doa, NMSE_doa, prob_doa = calculate_error(doa_est, label_theta, num_sources)
        print(f"RMSE: {RMSE_doa}, NMSE: {NMSE_doa}, prob: {prob_doa}")

        label = np.zeros_like(result_)
        for bat_id in range(result.shape[0]):
            for idx in range(result.shape[-2]):
                if int(idx - 60) == int(label_theta[:, bat_id, :]):
                    label[bat_id, idx, :] = 1

        RMSE = np.sqrt(np.mean((result_ - label) ** 2))
        NMSE = np.mean((result_ - label) ** 2) / np.mean(label ** 2)
        NMSE_dB = 10 * np.log10(np.mean((result_ - label) ** 2) / np.mean(label ** 2))
        print(f"RMSE: {RMSE}, NMSE: {NMSE}, NMSE_dB: {NMSE_dB}")

        if batch_size == 1:

            label = np.zeros_like(result.cpu().detach().numpy())
            for bat_id in range(result.shape[0]):
                for idx in range(result.shape[-2]):
                    if int(idx) == int(label_theta[bat_id] + 60):
                        # label[bat_id, :, idx, :] = 1
                        label[bat_id, :, idx, :] = 1

            label = torch.from_numpy(label).to(torch.float32)
            if idx_epc % 1 == 0:
                for chanel in range(result_mulchannels.shape[1]):
                    plt.plot(result_mulchannels[0, chanel].cpu().detach().numpy(), ls='-', alpha=0.5,
                             linewidth=0.4)
                plt.plot(result[0].cpu().detach().numpy().reshape(-1), label=f'Result: {fre_center.item()}Hz', ls='-',
                         color='k', linewidth=1.5)
                # for x_idx in range(label.shape[-2]):
                plt.axvline(x=label_theta[0, 0] + 60, color='r', linestyle='--', linewidth=1, label='Ground Truth')
                # plt.plot(label[0].cpu().detach().numpy().reshape(-1), label='Label')
                plt.xlabel('Angles (Degrees)')
                plt.ylabel('Normalized Amplitude')
                # plt.plot(label[0].cpu().detach().numpy().reshape(-1), label='Label')
                # plt.title(f"Estimated Power Spectrum \n  \n {fre_center.item()} / {fre_fault.item()} \n {label_SNR[0][0].item()} / {label_SNR[0][1].item()} ")
                plt.title(f"Estimated Power Spectrum")
                plt.legend()
                plt.savefig(f"../../Test/Test_model/SNR_-10/{idx_epc}.pdf")
                plt.show()
